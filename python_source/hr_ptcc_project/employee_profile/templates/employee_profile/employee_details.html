{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="d-flex flex-column">
        <div class="p-2">
            <div class="d-flex flex-row">
                <div class="p-2">
                    <div class="employee_spec_details">
                        <table>
                            <tr>
                                <th>Employee Name:</th>
                                <td><h4><strong>{{employee.name}}</strong></h4></td>
                            </tr>
                            <tr>
                                <th>Hired Date:</th>
                                <td id="hired_date">{{employee.hired_date}}</td>
                            </tr>
                            <tr>
                                <th>Probation Date:</th>
                                <td id="probation_date">{{employee.probation_date}}</td>
                            </tr>
                            <tr>
                                <th>SL Start Date:</th>
                                <td id="sl_start_date">{{employee.sl_start_date}}</td>
                            </tr>
                            <tr>
                                <th>Regularization Date:</th>
                                <td class="editable-employee" 
                                    data-id="{{employee.id}}" 
                                    data-table="employee"
                                    data-type="regularization_date"
                                    name="format_date">{{employee.regularization_date}}
                                </td>
                            </tr>
                            <tr>
                                <th>Employee Status:</th>
                                <td class="editable-employee" 
                                    data-id="{{employee.id}}" 
                                    data-table="employee"
                                    data-type="employee_status"
                                    name="format_select">{{employee.employee_status}}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="p-2">
                    <div class="config_buttons">
                        <div class="d-flex justify-content-between">
                            <div class="p-2">
                                <button type="button" class="btn btn-primary config_button_style" id="save_employee" disabled="true">SAVE</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ml-auto p-2">
                    <label for="employee-details-year-selection">Year</label>
                    <select id="employee-details-year-selection"></select>
                </div>
            </div>
        </div>
        <div class="p-2">
            <div class="d-flex flex-row">
                <div class="p-2 earned_leave">
                    <h5><strong>Bi-Monthly Earned Credits</strong></h5>
                    <div class="earned_leave_tbl_container" style="overflow:auto;height: 700px;width: 450px;">
                        <table class="table table-hover earned_leave_table">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">Cut-off</th>
                                    <th scope="col">Vacation</th>
                                    <th scope="col">Sick</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-id='{{employee.id}}' data-table='employee'>
                                    <th scope="row">Beg. Bal</th>
                                    <td 
                                        class="editable" 
                                        data-type="prev_vl_bal" 
                                        scope="row"
                                        name="format_float">
                                        {{employee.prev_vl_bal}}
                                    </td>
                                    <td 
                                        class="editable"
                                        data-type="prev_sl_bal"
                                        scope="row"
                                        name="format_float">
                                            {{employee.prev_sl_bal}}
                                    </td>
                                    <td>
                                        <button style="border:none;background:none;" class="add" title="Add" data-toggle="tooltip" hidden="true"><i class="material-icons"></i></button>
                                        <button style="border:none;background:none;display:inline-block;" class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="p-2 leaves_taken">
                    <div class="d-flex flex-row">
                        <div class="p-2">
                            <h5><strong>Leaves Taken</strong></h5>
                        </div>
                        <div class="ml-auto p-2">
                            <button type="button" class="btn btn-info add-new" data-table="leaves_taken_table">+ Add New</button>
                        </div>
                    </div>
                    <div style="overflow:auto;height: 700px;">
                        <table class="table table-hover leaves_taken_table">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">No. of Days</th>
                                    <th scope="col">Type of Leave</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="p-2 offenses">
                    <div class="d-flex flex-row">
                        <div class="p-2">
                            <h5><strong>Offenses</strong></h5>
                        </div>
                        <div class="ml-auto p-2">
                            <button type="button" class="btn btn-info add-new" data-table="offenses_table">+ Add New</button>
                        </div>
                    </div>
                    <div style="overflow:auto;height: 700px;">
                        <table class="table table-hover offenses_table">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Offense Name</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="saveModalLabel">Saving data</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body save-modal-body">
                
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="save_button_close">Cancel</button>
            <button type="button" class="btn btn-primary" id="save_button_modal">Save changes</button>
            </div>
        </div>
        </div>
    </div>
{% endblock content %}

{% block custom_js %}
    <script type="text/javascript">
        $(document).ready(function() {
            //this is the container to hold the changes made by the user
            var model_changes_dict = {
                "add":[],
                "edit":[],
                "delete":[],
            };
            // initialize tables and selection year
            initialize();

            $(document).on("dblclick", ".editable-employee", function() {
               var value = ($(this).text()).trim();
               var data_type = $(this).data("type");
               var name_element = $(this).attr("name");
               var input = "";

               if (name_element == "format_date") {
                    value = convertDate(value);
                    input = "<input type='date'" + 
                           "class='input-data-employee'" + 
                           "value='"+value+"'>";
               } else if(name_element == "format_select") {
                    if (data_type == "employee_status") {
                            input = "<select class='input-data-employee'>" +
                                        "<option>"+value+"</option>" +
                                        "<option value='P'>P</option>" +
                                        "<option value='R1'>R1</option>" +
                                        "<option value='R'>R</option>" +
                                    "</select>";
                    } 
               }

               $(this).html(input);
               $("#save_employee").attr("disabled", false);
            });

            $(document).on("blur", ".input-data-employee", function(){
                var input_values_dict = enterInput2($(this));
                model_changes_dict["edit"].push(input_values_dict);
            });

            $(document).on("keypress", ".input-data-employee", function(e) {
                var key = e.which;

                if (key == 13) {
                    var input_values_dict = enterInput2($(this));
                    model_changes_dict["edit"].push(input_values_dict);
                }
            });
            
            $("#save_employee").click(function() {
                $("#saveModal").modal();
                message = "You made the following changes: <br>";
                total_edit = model_changes_dict["edit"].length;
                total_delete = model_changes_dict["delete"].length;
                total_add = model_changes_dict["add"].length;

                if (total_edit > 0) {
                    message += "Edited " + total_edit + " item(s)<br>";
                }
                if (total_delete > 0) {
                    message += "Deleted " + total_delete + " item(s)<br>";
                }
                if (total_add > 0) {
                    message += "Added " + total_add + " item(s)<br>";
                }

                message += "<br>Are you sure you want to add the changes?";

                $("#save_button_modal").attr("disabled", false);
                if (!total_add && !total_edit && !total_delete) {
                    message = "You have not made any changes<br>";
                    $("#save_button_modal").attr("disabled", true);
                }
                
                $(".save-modal-body").html(message);
            });

            $("#save_button_modal").click(function() {
                sendToServer(model_changes_dict);
                $("#save_employee").attr("disabled", true);
                $("#saveModal").modal("hide");
            });

            $("#info_button_close").click(function() {
                $("#infoModal").modal("hide");
                location.reload(true);
            });

            $("#save_button_close").click(function() {
                location.reload(true);
                $("#saveModal").modal("hide");
            });

            $("#employee-details-year-selection").on("change", function(){
                // remove all elements with class "removable"
                $(".removable").remove();
                $('[data-toggle="tooltip"]').tooltip()
                displayEarnedLeave();
                displayLeavesTaken();
                displayOffenses();
            });
            
            //action add button
            $("body").on('click', '.add', function() {
                $("#save_employee").attr("disabled", false);
                var cell_container = $(this).parent("td");
                var row_container = cell_container.parent("tr");
                var edit_element = cell_container.find(".edit");

                //check for error first
                var error_flag = checkInvalidInput(row_container);
                if (error_flag == 0) {
                    input_values_dict = enterInput(row_container);
                    if (input_values_dict["id"].includes("new")) {
                        model_changes_dict["add"].push(input_values_dict);
                    } else {
                        model_changes_dict["edit"].push(input_values_dict);
                    }
                }
            });

            //action edit button
            $("body").on('click', '.edit', function(){
                console.log("edit button clicked");
                var cell_container = $(this).parent("td");
                var row_container = cell_container.parent("tr");
                var add_element = cell_container.find(".add");
                
                add_element.attr("hidden", false);
                $(this).attr("hidden", true);
                $.each(row_container.find(".editable"), function() {
                    var data_type = $(this).data("type");
                    var value = ($(this).text()).trim();
                    var name_element = $(this).attr("name");
                    var input;

                    //determine what type of input html to display
                    if (name_element == "format_date") {
                            value = convertDate(value);
                            input = "<input type='date'" + 
                                    "class='input-data'" + 
                                    "value='"+value+"'>";
                    } else if(name_element == "format_select") {
                        if (data_type == "employee_status") {
                                input = "<select class='input-data'>" +
                                            "<option>"+value+"</option>" +
                                            "<option value='P'>P</option>" +
                                            "<option value='R1'>R1</option>" +
                                            "<option value='R'>R</option>" +
                                        "</select>";
                        } else if (data_type == "type") {
                                input = "<select class='input-data'>" +
                                            "<option>"+value+"</option>" +
                                            "<option value='SL'>SL</option>" +
                                            "<option value='VL'>VL</option>" +
                                        "</select>";
                        } else if (data_type == "offense_name") {
                                input = "<select class='input-data'>" +
                                            "<option>"+value+"</option>" +
                                            "<option value='Late'>Late</option>" +
                                            "<option value='No Time-in'>No Time-in</option>" +
                                            "<option value='No Time-out'>No Time-out</option>" +
                                        "</select>";
                        } 
                    }else {
                            input = "<input type='text'" + 
                                    "class='input-data'" + 
                                    "value='"+value+"'>";
                    }
                    $(this).html(input);
                    $('input[type="text"]')
                    // event handler
                    .keyup(resizeInput)
                    // resize on page load
                    .each(resizeInput);
                });
            });

            //action delete button
            $("body").on("click", ".delete", function() {
                $("#save_employee").attr("disabled", false);
                var delete_values_dict = {};
                cell_container = $(this).parent("td");
                row_container = cell_container.parent("tr");
                
                var id = row_container.data("id").toString();
                var table = row_container.data("table");
                delete_values_dict["id"] = id;
                delete_values_dict["table"] = table;
                //check if substring "new" is included in the id string
                if (id.indexOf("new") === -1) {
                    model_changes_dict["delete"].push(delete_values_dict);
                } else {
                    //remove the new added entry in the model changes container
                    var add_changes = model_changes_dict["add"];
                    for(var i = 0; i < add_changes.length; i++) {
                        if(add_changes[i]["id"] == id){
                            add_changes.splice(i, 1);
                        }
                    }
                }
                row_container.remove();
            });

            $(".add-new").click(function (){
                table = $(this).data("table");
                if (table == "leaves_taken_table") {
                    row_html = "<tr class='removable' data-id='{{employee.id}}-new' data-table='leave'>" +
                                "<td class='editable' data-type='date' name='format_date'></td>" +
                                "<td class='editable' data-type='days' name='format_float' scope='row'></td>" +
                                "<td class='editable' data-type='type' name='format_select' scope='row'></td>" +
                                '<td>'+
                                    '<button style="border:none;background:none;" class="add" title="Add" data-toggle="tooltip" hidden="true"><i class="material-icons"></i></button>'+
                                    '<button style="border:none;background:none;display:inline-block;" class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                    '<button style="border:none;background:none;" class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                '</td>'+
                            "</tr>";
                    table_class_name = "." + table;
                }
                else if (table == "offenses_table") {
                    row_html = "<tr class='removable' data-id='{{employee.id}}-new' data-table='offense'>" +
                                    "<td class='editable' data-type='date' name='format_date' scope='row'></td>" +
                                    "<td class='editable' data-type='offense_name' name='format_select' scope='row'></td>" +
                                    '<td>'+
                                        '<button style="border:none;background:none;" class="add" title="Add" data-toggle="tooltip" hidden="true"><i class="material-icons"></i></button>'+
                                        '<button style="border:none;background:none;display:inline-block;" class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                        '<button style="border:none;background:none;" class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                    '</td>'+
                                "</tr>";
                    table_class_name = "." + table;
                }

                $(table_class_name).append(row_html);
            });

            function initialize() {
                $('[data-toggle="tooltip"]').tooltip()
                populateYearSelection();
                displayEarnedLeave();
                displayLeavesTaken();
                displayOffenses();
            }

            function displayEarnedLeave(){
                var year_selected = $("#employee-details-year-selection option:selected").text();
                var row_html = "";
                var total_vl = parseFloat("{{employee.prev_vl_bal}}");
                var total_sl = parseFloat("{{employee.prev_sl_bal}}");

                {% for vl, sl in employee.get_earned_leaves %}
                    var date_string = "{{vl.cut_off.isoformat}}";
                    var date_js = new Date(date_string);
                    var leave_year = date_js.getFullYear().toString();
                    if (date_js.getFullYear().toString() == year_selected) {
                        row_html += "<tr class='removable' data-id='{{vl.id}}-{{sl.id}}' data-table='earned'>"+
                                        "<th scope='row'>{{vl.cut_off}}</th>"+
                                        "<td class='editable' data-type='{{vl.type}}' name='format_float' scope='row'>{{vl.value}}</td>"+
                                        "<td class='editable' data-type='{{sl.type}}' name='format_float' scope='row'>{{sl.value}}</td>"+
                                        '<td>'+
                                            '<button style="border:none;background:none;" class="add" title="Add" data-toggle="tooltip" hidden="true"><i class="material-icons"></i></button>'+
                                            '<button style="border:none;background:none;display:inline-block;" class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                        '</td>'+
                                    "</tr>";
                        
                        vl_value_int = "{{vl.value}}";
                        sl_value_int = "{{sl.value}}";

                        total_vl += parseFloat(vl_value_int);
                        total_sl += parseFloat(sl_value_int);
                    }
                {% endfor %}
                
                var total_sl_vl_html = "<tr class='removable'>"+
                                            "<th scope='row'>Total</th>" +
                                            "<td>" + total_vl.toFixed(3) +"</td>" +
                                            "<td>" + total_sl.toFixed(3) +"</td>" +
                                       "</tr>"
                row_html += total_sl_vl_html;
                $(".earned_leave_table").append(row_html);
            }

            function displayLeavesTaken(){
                var year_selected = $("#employee-details-year-selection option:selected").text();
                var row_html = "";
                {% for leave in employee.leave_set.all %}
                    var date_string = "{{leave.date.isoformat}}";
                    var date_js = new Date(date_string);
                    var leave_year = date_js.getFullYear().toString();
                    if (date_js.getFullYear().toString() == year_selected) {
                        row_html += "<tr class='removable' data-id='{{leave.id}}' data-table='leave'>" +
                                        "<td class='editable' data-type='date' name='format_date'>{{leave.date}}</td>" +
                                        "<td class='editable' data-type='days' name='format_float' scope='row'>{{leave.days}}</td>" +
                                        "<td class='editable' data-type='type' name='format_select' scope='row'>{{leave.type}}</td>" +
                                        '<td>'+
                                            '<button style="border:none;background:none;" class="add" title="Add" data-toggle="tooltip" hidden="true"><i class="material-icons"></i></button>'+
                                            '<button style="border:none;background:none;display:inline-block;" class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                            '<button style="border:none;background:none;" class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                        '</td>'+
                                    "</tr>";
                    }
                {% endfor %}
                $(".leaves_taken_table").append(row_html);
            }

            function displayOffenses(){
                var year_selected = $("#employee-details-year-selection option:selected").text();
                var row_html = "";
                {% for offense in employee.offense_set.all %}
                    var date_string = "{{offense.date.isoformat}}";
                    var date_js = new Date(date_string);
                    var leave_year = date_js.getFullYear().toString();
                    if (date_js.getFullYear().toString() == year_selected) {
                        row_html += "<tr class='removable' data-id='{{offense.id}}' data-table='offense'>" +
                                        "<td class='editable' data-type='date' name='format_date' scope='row'>{{offense.date}}</td>" +
                                        "<td class='editable' data-type='offense_name' name='format_select' scope='row'>{{offense.offense_name}}</td>" +
                                        '<td>'+
                                            '<button style="border:none;background:none;" class="add" title="Add" data-toggle="tooltip" hidden="true"><i class="material-icons"></i></button>'+
                                            '<button style="border:none;background:none;display:inline-block;" class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                            '<button style="border:none;background:none;" class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons"></i></button>'+
                                        '</td>'+
                                    "</tr>";
                    }
                {% endfor %}
                $(".offenses_table").append(row_html);
            }

            function populateYearSelection() {
                var start_year = 2000;
                var end_year = new Date().getFullYear();
                var options = "";
                for (var year = end_year; year >= start_year; year-- ) {
                    options += "<option value=" + year +">"+ year + "</option>";
                }
                $("#employee-details-year-selection").html(options);
            }

            //function to check for incorrect input in the table cell
            function checkInvalidInput(row_container) {
                var error_flag = 0;
                $.each(row_container.find(".editable"), function() {
                    var name_input_element = $(this).attr("name");
                    var input_element = $(this).find(".input-data");
                    var value = (input_element.val()).trim();
                    var year_selected = $("#employee-details-year-selection option:selected").text();

                    $(this).removeClass("error");
                    if(name_input_element == "format_float") {
                        if (isNaN(value) || value === "") {
                            $(this).addClass("error");
                            error_flag = 1;
                        }
                    } else if(name_input_element == "format_date") {
                        var date_js = new Date(value);
                        var date_obj = convertDate(value);
                        //checking if the chosen year of the date is equal to the year selection
                        if (date_obj == "NaN-aN-aN" || date_js.getFullYear().toString() != year_selected) {
                            $(this).addClass("error");
                            error_flag = 1;
                        } 
                    } else if(name_input_element == "format_select") {
                        if (value == "") {
                            $(this).addClass("error");
                            error_flag = 1;
                        }
                    }
                });
                return error_flag;
            }

            // function serves the add edit and delete of table objects
            function enterInput(row_container) {
                var input_values_dict = {};
                var id = row_container.data("id");
                var table = row_container.data("table");

                input_values_dict["id"] = id;
                input_values_dict["table"] = table;
                $.each(row_container.find(".editable"), function(){
                    var type = $(this).data("type");
                    var name_input_element = $(this).attr("name");
                    var input_element = $(this).find(".input-data");
                    var value = (input_element.val()).trim();
                    if(name_input_element == "format_date") {
                        value = convertDate(value);
                    }

                    input_values_dict[type] = value;
                    input_element.remove();
                    $(this).html(value);
                });
                $(".add").attr("hidden", true);
                $(".edit").attr("hidden", false);
                return input_values_dict;
            }

            // this function serves the editing of employee data
            function enterInput2(input_element) {
                var input_values_dict = {};
                var parent_container = input_element.parent("td");
                var id = parent_container.data("id");
                var table = parent_container.data("table");
                var type = parent_container.data("type");
                var type_of_input = parent_container.attr("name");

                var value = (input_element.val()).trim();
                if(type_of_input == "format_date") {
                    value = convertDate(value);
                }

                input_element.remove();
                parent_container.html(value);

                input_values_dict["id"] = id;
                input_values_dict["table"] = table;
                input_values_dict[type] = value;

                return input_values_dict;
            }
            function resizeInput() {
                $(this).attr('size', $(this).val().length);
            }

            function convertDate(date_string) {
                var month_shortcuts = {
                    "Jan.": "January",
                    "Feb.": "February",
                    "Aug.": "August",
                    "Sept." : "September",
                    "Oct." : "October",
                    "Nov." : "November",
                    "Dec." : "December"
                };
                
                var month = date_string.split(" ")[0];
                if (month.includes(".")) {
                    date_string = date_string.replace(month, month_shortcuts[month]);
                }
                var options = { year: 'numeric', month: 'long', day: 'numeric' };
                var date = new Date(date_string);
                var dateString;

                if(isNaN(date_string[0])) {
                    dateString = (date.getFullYear() + "-" + ("0" + (date.getMonth()+1)).slice(-2) + "-" + ("0" + date.getDate()).slice(-2));
                } else {
                    dateString = date.toLocaleDateString("en-US", options)
                }
                return dateString;
            }

            function sendToServer(model_changes_dict) {
                console.log(model_changes_dict);
                url = "{% url 'employee_profile:save_changes' %}";
                data = {
                    "model_changes_dict": JSON.stringify(model_changes_dict)
                }
                    $.ajax({
                        url:url,
                        type: "POST",
                        dataType: "json",
                        data: data
                    })
                    .done(function(response) {
                        $(".info-modal-title").html(response.head);
                        $(".info-modal-body").html(response.body);
                        $("#infoModal").modal();
                        model_changes_dict = {
                            "edit":[],
                            "delete":[]
                        };
                    })
                    .fail(function(xhr, status, error) {
                        $(".info-modal-title").html("Failed");
                        $(".info-modal-body").html("Failed to save data! details: " + (xhr.responseText).split(".")[0]);
                        $("#infoModal").modal();
                    });
            }
        });
    </script>
{% endblock custom_js %}